# üß™ Guide de Test - Tajdeed Backend

## Vue d'ensemble

Ce document fournit un guide complet pour tester toutes les fonctionnalit√©s impl√©ment√©es du backend Tajdeed, incluant l'authentification (Google OAuth, Email/Password avec v√©rification email) et le syst√®me de mod√©ration.

## üìã Table des mati√®res

1. [Pr√©requis](#pr√©requis)
2. [Installation](#installation)
3. [Tests Automatiques](#tests-automatiques)
4. [Tests Manuels avec Postman/Insomnia](#tests-manuels-avec-postmaninsomnia)
5. [Sc√©narios de Test](#sc√©narios-de-test)
6. [D√©pannage](#d√©pannage)

---

## Pr√©requis

### Logiciels requis

- **Node.js** : v18 ou sup√©rieur
- **Yarn** : v1.22 ou sup√©rieur
- **PostgreSQL** : v14 ou sup√©rieur
- **Postman** ou **Insomnia** : Pour les tests manuels

### Variables d'environnement

Cr√©ez un fichier `.env` √† la racine du projet :

```env
# Base de donn√©es
DATABASE_URL="postgresql://user:password@localhost:5432/tajdeed_db"

# Configuration de l'application
PORT=3000
APP_URL=http://localhost:3000
NODE_ENV=development

# Configuration Better Auth
BETTER_AUTH_SECRET="votre-secret-key-ici" # G√©n√©rez avec: openssl rand -hex 32
BETTER_AUTH_URL=http://localhost:3000

# Configuration Google OAuth
GOOGLE_CLIENT_ID="votre-google-client-id"
GOOGLE_CLIENT_SECRET="votre-google-client-secret"

# Configuration Email (ReplitMail)
REPLIT_MAIL_API_KEY="votre-replit-mail-api-key"

# JWT
JWT_SECRET="votre-jwt-secret" # G√©n√©rez avec: openssl rand -hex 32
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d
```

---

## Installation

```bash
# 1. Installer les d√©pendances
yarn install

# 2. G√©n√©rer le client Prisma
yarn prisma:generate

# 3. Cr√©er la base de donn√©es et appliquer les migrations
yarn prisma:migrate

# 4. (Optionnel) Voir la base de donn√©es avec Prisma Studio
yarn prisma:studio
```

---

## Tests Automatiques

### Lancer tous les tests

```bash
# Tests E2E complets
yarn test:e2e

# Tests avec couverture
yarn test:cov

# Mode watch (d√©veloppement)
yarn test:watch
```

### Lancer des tests sp√©cifiques

```bash
# Tests d'authentification Google
yarn test:e2e auth.e2e-spec

# Tests d'authentification Email/Password
yarn test:e2e auth-email.e2e-spec

# Tests de mod√©ration
yarn test:e2e moderation.e2e-spec
```

### Structure des tests

```
test/
‚îú‚îÄ‚îÄ auth.e2e-spec.ts           # Tests OAuth Google
‚îú‚îÄ‚îÄ auth-email.e2e-spec.ts     # Tests Email/Password
‚îú‚îÄ‚îÄ moderation.e2e-spec.ts     # Tests syst√®me de mod√©ration
‚îî‚îÄ‚îÄ jest-e2e.json              # Configuration Jest
```

---

## Tests Manuels avec Postman/Insomnia

### üì• Importer la collection

Cr√©ez une collection avec les endpoints suivants :

### Variables d'environnement de la collection

```
baseUrl: http://localhost:3000
accessToken: (sera rempli apr√®s connexion)
refreshToken: (sera rempli apr√®s connexion)
userId: (sera rempli apr√®s inscription)
moderatorToken: (sera rempli apr√®s connexion mod√©rateur)
```

---

## üîê Endpoints d'Authentification Email/Password

### 1. Inscription (Register)

**Endpoint:** `POST {{baseUrl}}/auth/register/email`

**Body (JSON):**
```json
{
  "email": "test@example.com",
  "password": "Password123!",
  "username": "testuser",
  "name": "Test User"
}
```

**R√©ponse attendue (201):**
```json
{
  "success": true,
  "message": "Inscription r√©ussie. Veuillez v√©rifier votre email pour activer votre compte.",
  "user": {
    "id": "uuid",
    "email": "test@example.com",
    "name": "Test User",
    "emailVerified": false
  }
}
```

**Tests √† effectuer:**
- ‚úÖ Inscription avec donn√©es valides
- ‚ùå Inscription avec email d√©j√† utilis√©
- ‚ùå Inscription avec mot de passe faible
- ‚ùå Inscription avec email invalide

---

### 2. V√©rification d'email

**Endpoint:** `POST {{baseUrl}}/auth/verify-email`

**Body (JSON):**
```json
{
  "token": "token-re√ßu-par-email"
}
```

**Comment obtenir le token pour les tests :**

Pendant les tests, le token de v√©rification est affich√© dans les logs du serveur. Cherchez :
```
Email de v√©rification envoy√© √† test@example.com
Token de v√©rification: abc123def456...
```

**R√©ponse attendue (200):**
```json
{
  "success": true,
  "message": "Email v√©rifi√© avec succ√®s",
  "autoSignIn": true,
  "accessToken": "jwt-token",
  "refreshToken": "refresh-token",
  "user": {
    "id": "uuid",
    "email": "test@example.com",
    "emailVerified": true
  }
}
```

---

### 3. Connexion (Login)

**Endpoint:** `POST {{baseUrl}}/auth/login/email`

**Body (JSON):**
```json
{
  "email": "test@example.com",
  "password": "Password123!"
}
```

**R√©ponse attendue (200):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "refresh_token_ici",
  "user": {
    "id": "uuid",
    "email": "test@example.com",
    "name": "Test User",
    "role": "USER",
    "status": "ACTIVE"
  }
}
```

**‚ö†Ô∏è Important:** Copiez l'`accessToken` et le `refreshToken` pour les requ√™tes suivantes !

**Tests √† effectuer:**
- ‚úÖ Connexion avec identifiants valides
- ‚ùå Connexion avec email non v√©rifi√©
- ‚ùå Connexion avec mot de passe incorrect
- ‚ùå Connexion avec email inexistant
- ‚ùå Connexion avec compte suspendu/banni

---

### 4. Renvoyer l'email de v√©rification

**Endpoint:** `POST {{baseUrl}}/auth/resend-verification`

**Body (JSON):**
```json
{
  "email": "test@example.com"
}
```

**R√©ponse attendue (200):**
```json
{
  "success": true,
  "message": "Email de v√©rification renvoy√© avec succ√®s"
}
```

---

### 5. Demande de r√©initialisation de mot de passe

**Endpoint:** `POST {{baseUrl}}/auth/forgot-password`

**Body (JSON):**
```json
{
  "email": "test@example.com"
}
```

**R√©ponse attendue (200):**
```json
{
  "success": true,
  "message": "Email de r√©initialisation envoy√©"
}
```

---

### 6. R√©initialisation de mot de passe

**Endpoint:** `POST {{baseUrl}}/auth/reset-password`

**Body (JSON):**
```json
{
  "token": "token-re√ßu-par-email",
  "newPassword": "NewPassword123!"
}
```

**R√©ponse attendue (200):**
```json
{
  "success": true,
  "message": "Mot de passe r√©initialis√© avec succ√®s"
}
```

---

### 7. Rafra√Æchir le token

**Endpoint:** `POST {{baseUrl}}/auth/refresh`

**Body (JSON):**
```json
{
  "refreshToken": "votre-refresh-token"
}
```

**R√©ponse attendue (200):**
```json
{
  "accessToken": "nouveau-access-token",
  "refreshToken": "nouveau-refresh-token"
}
```

---

### 8. D√©connexion (Logout)

**Endpoint:** `POST {{baseUrl}}/auth/logout`

**Headers:**
```
Authorization: Bearer {{accessToken}}
```

**R√©ponse attendue (200):**
```json
{
  "success": true,
  "message": "D√©connexion r√©ussie"
}
```

---

### 9. Obtenir le profil utilisateur

**Endpoint:** `GET {{baseUrl}}/auth/profile`

**Headers:**
```
Authorization: Bearer {{accessToken}}
```

**R√©ponse attendue (200):**
```json
{
  "id": "uuid",
  "email": "test@example.com",
  "name": "Test User",
  "username": "testuser",
  "role": "USER",
  "status": "ACTIVE",
  "emailVerified": true,
  "createdAt": "2025-01-01T00:00:00.000Z"
}
```

---

## üõ°Ô∏è Endpoints de Mod√©ration

### Configuration pr√©alable

Pour tester les endpoints de mod√©ration, vous devez avoir un compte avec le r√¥le `ADMIN`. Cr√©ez-le via Prisma Studio ou SQL :

```sql
UPDATE "users" SET role = 'ADMIN' WHERE email = 'admin@example.com';
```

### 1. Appliquer une action de mod√©ration

**Endpoint:** `POST {{baseUrl}}/moderation/actions`

**Headers:**
```
Authorization: Bearer {{moderatorToken}}
Content-Type: application/json
```

**Body (JSON):**
```json
{
  "userId": "uuid-de-l-utilisateur-cible",
  "action": "WARNING",
  "reason": "Contenu inappropri√© publi√©",
  "duration": null,
  "evidence": "https://example.com/screenshot.png"
}
```

**Actions disponibles:**
- `WARNING` : Avertissement simple
- `TEMPORARY_SUSPENSION` : Suspension temporaire (sp√©cifier `duration` en heures)
- `PERMANENT_BAN` : Bannissement permanent
- `CONTENT_REMOVAL` : Suppression de contenu
- `ACCOUNT_RESTRICTION` : Restriction de compte

**Exemple avec suspension temporaire:**
```json
{
  "userId": "uuid",
  "action": "TEMPORARY_SUSPENSION",
  "reason": "Spam r√©p√©t√©",
  "duration": 72,
  "evidence": null
}
```

**R√©ponse attendue (201):**
```json
{
  "id": "uuid",
  "userId": "uuid",
  "moderatorId": "uuid",
  "action": "WARNING",
  "reason": "Contenu inappropri√© publi√©",
  "isActive": true,
  "createdAt": "2025-01-01T00:00:00.000Z"
}
```

---

### 2. Envoyer un avertissement √† un utilisateur

**Endpoint:** `POST {{baseUrl}}/moderation/warnings`

**Headers:**
```
Authorization: Bearer {{moderatorToken}}
Content-Type: application/json
```

**Body (JSON):**
```json
{
  "userId": "uuid-de-l-utilisateur",
  "reason": "Langage inappropri√© dans les commentaires",
  "severity": "MEDIUM"
}
```

**Niveaux de s√©v√©rit√©:**
- `LOW` : Avertissement l√©ger
- `MEDIUM` : Avertissement moyen
- `HIGH` : Avertissement s√©v√®re
- `CRITICAL` : Avertissement critique

**R√©ponse attendue (201):**
```json
{
  "id": "uuid",
  "userId": "uuid",
  "reason": "Langage inappropri√© dans les commentaires",
  "severity": "MEDIUM",
  "isRead": false,
  "createdAt": "2025-01-01T00:00:00.000Z"
}
```

---

### 3. Obtenir l'historique de mod√©ration d'un utilisateur

**Endpoint:** `GET {{baseUrl}}/moderation/history/:userId`

**Headers:**
```
Authorization: Bearer {{moderatorToken}}
```

**Exemple:** `GET {{baseUrl}}/moderation/history/123e4567-e89b-12d3-a456-426614174000`

**R√©ponse attendue (200):**
```json
{
  "userId": "uuid",
  "currentStatus": "ACTIVE",
  "moderationActions": [
    {
      "id": "uuid",
      "action": "WARNING",
      "reason": "Contenu inappropri√©",
      "moderator": {
        "id": "uuid",
        "name": "Admin User"
      },
      "createdAt": "2025-01-01T00:00:00.000Z"
    }
  ],
  "warnings": [
    {
      "id": "uuid",
      "reason": "Langage inappropri√©",
      "severity": "MEDIUM",
      "isRead": false,
      "createdAt": "2025-01-01T00:00:00.000Z"
    }
  ]
}
```

---

### 4. Lister les utilisateurs mod√©r√©s

**Endpoint:** `GET {{baseUrl}}/moderation/moderated-users`

**Headers:**
```
Authorization: Bearer {{moderatorToken}}
```

**Query Parameters (optionnels):**
```
action: WARNING|TEMPORARY_SUSPENSION|PERMANENT_BAN
status: ACTIVE|SUSPENDED|BANNED
moderatorId: uuid
page: 1
limit: 20
```

**Exemple:** `GET {{baseUrl}}/moderation/moderated-users?action=WARNING&limit=10`

**R√©ponse attendue (200):**
```json
{
  "data": [
    {
      "id": "uuid",
      "userId": "uuid",
      "moderatorId": "uuid",
      "action": "WARNING",
      "reason": "Contenu inappropri√©",
      "user": {
        "id": "uuid",
        "email": "user@example.com",
        "name": "User Name",
        "status": "ACTIVE"
      },
      "moderator": {
        "id": "uuid",
        "name": "Admin Name"
      },
      "createdAt": "2025-01-01T00:00:00.000Z"
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 20
}
```

---

### 5. R√©voquer une action de mod√©ration

**Endpoint:** `POST {{baseUrl}}/moderation/revoke/:actionId`

**Headers:**
```
Authorization: Bearer {{moderatorToken}}
Content-Type: application/json
```

**Body (JSON):**
```json
{
  "reason": "Erreur dans l'√©valuation initiale"
}
```

**Exemple:** `POST {{baseUrl}}/moderation/revoke/123e4567-e89b-12d3-a456-426614174000`

**R√©ponse attendue (200):**
```json
{
  "success": true,
  "message": "Action de mod√©ration r√©voqu√©e avec succ√®s"
}
```

---

### 6. Obtenir les statistiques de mod√©ration

**Endpoint:** `GET {{baseUrl}}/moderation/stats`

**Headers:**
```
Authorization: Bearer {{moderatorToken}}
```

**R√©ponse attendue (200):**
```json
{
  "totalActions": 150,
  "activeWarnings": 12,
  "bannedUsers": 5,
  "suspendedUsers": 3,
  "actionsThisMonth": 42,
  "topReasons": [
    {
      "reason": "Contenu inappropri√©",
      "count": 25
    },
    {
      "reason": "Spam",
      "count": 18
    }
  ]
}
```

---

### 7. Obtenir les avertissements d'un utilisateur

**Endpoint:** `GET {{baseUrl}}/moderation/warnings/:userId`

**Headers:**
```
Authorization: Bearer {{accessToken}}
```

**Exemple:** `GET {{baseUrl}}/moderation/warnings/me` (pour l'utilisateur connect√©)

**R√©ponse attendue (200):**
```json
{
  "warnings": [
    {
      "id": "uuid",
      "reason": "Langage inappropri√©",
      "severity": "MEDIUM",
      "isRead": false,
      "createdAt": "2025-01-01T00:00:00.000Z"
    }
  ],
  "unreadCount": 1
}
```

---

### 8. Marquer les avertissements comme lus

**Endpoint:** `PATCH {{baseUrl}}/moderation/warnings/:userId/read`

**Headers:**
```
Authorization: Bearer {{accessToken}}
```

**Exemple:** `PATCH {{baseUrl}}/moderation/warnings/me/read`

**R√©ponse attendue (200):**
```json
{
  "success": true,
  "message": "Avertissements marqu√©s comme lus"
}
```

---

## üìù Sc√©narios de Test Complets

### Sc√©nario 1 : Parcours utilisateur complet

1. **Inscription**
   ```
   POST /auth/register/email
   ‚Üí V√©rifier que l'email de v√©rification est envoy√©
   ```

2. **V√©rification email**
   ```
   POST /auth/verify-email
   ‚Üí R√©cup√©rer le token des logs
   ‚Üí V√©rifier que le compte est activ√©
   ```

3. **Connexion**
   ```
   POST /auth/login/email
   ‚Üí Sauvegarder accessToken et refreshToken
   ```

4. **Obtenir le profil**
   ```
   GET /auth/profile
   ‚Üí V√©rifier que emailVerified = true
   ```

5. **Rafra√Æchir le token**
   ```
   POST /auth/refresh
   ‚Üí V√©rifier nouveaux tokens g√©n√©r√©s
   ```

6. **D√©connexion**
   ```
   POST /auth/logout
   ‚Üí V√©rifier que le token est invalid√©
   ```

---

### Sc√©nario 2 : Parcours de mod√©ration

1. **Cr√©er un utilisateur normal et un admin**
   ```sql
   -- Via Prisma Studio ou SQL
   UPDATE "users" SET role = 'ADMIN' WHERE email = 'admin@example.com';
   ```

2. **Connexion admin**
   ```
   POST /auth/login/email
   ‚Üí Sauvegarder moderatorToken
   ```

3. **Appliquer un avertissement**
   ```
   POST /moderation/actions
   Body: { "action": "WARNING", ... }
   ```

4. **V√©rifier l'historique**
   ```
   GET /moderation/history/:userId
   ‚Üí Voir l'action appliqu√©e
   ```

5. **L'utilisateur v√©rifie ses avertissements**
   ```
   GET /moderation/warnings/me
   ‚Üí Voir 1 avertissement non lu
   ```

6. **Marquer comme lu**
   ```
   PATCH /moderation/warnings/me/read
   ```

7. **R√©voquer l'action**
   ```
   POST /moderation/revoke/:actionId
   ‚Üí V√©rifier que isActive = false
   ```

---

### Sc√©nario 3 : Test de s√©curit√©

1. **Acc√®s sans authentification**
   ```
   GET /auth/profile (sans header Authorization)
   ‚Üí Doit retourner 401 Unauthorized
   ```

2. **Acc√®s mod√©ration sans r√¥le admin**
   ```
   POST /moderation/actions (avec token USER)
   ‚Üí Doit retourner 403 Forbidden
   ```

3. **Token expir√©**
   ```
   GET /auth/profile (avec vieux token)
   ‚Üí Doit retourner 401 Unauthorized
   ```

4. **Tentative de connexion compte banni**
   ```
   POST /auth/login/email (compte avec status = BANNED)
   ‚Üí Doit retourner 403 Forbidden
   ```

---

## üêõ D√©pannage

### Erreur : "Le nom 'describe' est introuvable"

**Cause:** Types Jest non install√©s ou mal configur√©s.

**Solution:**
```bash
yarn add -D @types/jest @types/node
```

### Erreur : "Impossible d'appeler cette expression. Le type 'typeof supertest' n'a aucune signature d'appel"

**Cause:** Import incorrect de supertest.

**Solution:** Utiliser `import request from 'supertest'` au lieu de `import * as request from 'supertest'`

### Erreur : "Module '@prisma/client' has no exported member 'User'"

**Cause:** Client Prisma non g√©n√©r√© apr√®s modification du sch√©ma.

**Solution:**
```bash
yarn prisma:generate
```

### Erreur de connexion √† la base de donn√©es

**Cause:** PostgreSQL non d√©marr√© ou URL de connexion incorrecte.

**Solution:**
```bash
# V√©rifier que PostgreSQL est d√©marr√©
# Windows:
sc query postgresql

# V√©rifier l'URL dans .env
DATABASE_URL="postgresql://user:password@localhost:5432/tajdeed_db"
```

### Token de v√©rification non re√ßu

**Cause:** Configuration email incorrecte.

**Solution:** Pendant les tests, les tokens sont affich√©s dans les logs du serveur. Activez les logs verbeux :

```env
LOG_LEVEL=debug
```

---

## üìä Couverture de code

Pour v√©rifier la couverture des tests :

```bash
yarn test:cov
```

Objectif de couverture :
- **Statements:** > 80%
- **Branches:** > 75%
- **Functions:** > 80%
- **Lines:** > 80%

---

## üîó Ressources suppl√©mentaires

- [Documentation NestJS Testing](https://docs.nestjs.com/fundamentals/testing)
- [Documentation Better Auth](https://better-auth.com)
- [Documentation Prisma](https://www.prisma.io/docs)
- [Documentation Jest](https://jestjs.io/docs/getting-started)
- [Documentation Supertest](https://github.com/visionmedia/supertest)

---

## ‚úÖ Checklist finale

Avant de soumettre ou d√©ployer :

- [ ] Tous les tests automatiques passent
- [ ] Tests manuels sur tous les endpoints effectu√©s
- [ ] Sc√©narios de s√©curit√© v√©rifi√©s
- [ ] Variables d'environnement configur√©es
- [ ] Base de donn√©es initialis√©e
- [ ] Documentation √† jour
- [ ] Logs propres sans erreurs

---

**Bon testing! üéâ**

Pour toute question ou probl√®me, consultez la documentation ou cr√©ez une issue sur le repository.
